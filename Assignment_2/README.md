# Assignment 2

This folder contains the bsv design of 4x4 systolic array and its verification environment.

## Folder structure:

* The below diagram illustrates the structure of files in this folder.
* The boxes which are colored are the files/folders which are intended for submition.
* Blue boxes are folders and green boxes are files

 ![sysfolderstructure drawio](https://github.com/user-attachments/assets/245572d8-7156-428e-b1ca-f31cfcb33eb7)

### Description of contents:
#### Folders:
1. FLOAT_SYSTOLIC_ARRAY_RESULTS/ ----> Contains simulation outputs of 15,000 float testcases
2. INT_SYSTOLIC_ARRAY_RESULTS/ -------> Contains simulation outputs of 15,000 int testcases
3. systolic_array_verif/ ---------------------> Contains the verification environment of systolic array
4. verilog/ ----------------------------------> Contains the generated verilog files



#### Files:
FLOAT_SYSTOLIC_ARRAY_RESULTS/:
1. FLOAT_SYSTOLIC_ARRAY_RESULTS ---------> Contains the simulation log of the terminal when 15,000 float testcases were simulated.
2. Mat_A.txt ------------------------------------> Contains the input matrix A of all the testcases.
3. Mat_AB.txt ----------------------------------> Contains the output produced by the systolic array RTL for all the testcases.
4. Mat_B.txt ------------------------------------> Contains the input matrix B of all the testcases.
5. Mat_exp.txt ---------------------------------> Contains the output of reference model for all the testcases.

INT_SYSTOLIC_ARRAY_RESULTS/:
1. INT_SYSTOLIC_ARRAY_RESULTS ------------> Contains the simulation log of the terminal when 15,000 int testcases were simulated.
2. Mat_A.txt -----------------------------------> Contains the input matrix A of all the testcases.
3. Mat_AB.txt ----------------------------------> Contains the output produced by the systolic array RTL for all the testcases.
4. Mat_B.txt -----------------------------------> Contains the input matrix B of all the testcases.
5. Mat_exp.txt ---------------------------------> Contains the output of reference model for all the testcases.

systolic_array_verif/:
1. FLOAT_RM.py -------------------------------> Contains reference model which does float MAC
2. INT_RM.py ----------------------------------> Contains reference model which does int MAC
3. Makefile.verif--------------------------------> Makefile which is used to simulate
4. SYSARRAY_RM.py --------------------------> Contains the reference model of 4x4 systolic array
5. test_mksystolic_array.py--------------------> Testbench which creates random input matrices and drives them to both systolic array RTL and reference model, checks the RTL output with output of reference model.

Assignment_2/:
1. MAC_fp32_pipelined.bsv ---------------------> Contains pipelined Float MAC unit which instantiates bf16_mul_pipelined and fp32_add_pipelined within it
2. MAC_int32_pipelined.bsv -------------------->  Contains pipelined Int MAC unit which has both 8 bit multiplier and 32 bit adder implemented as a single module
3. MAC_pipelined.bsv --------------------------->  Contains the Top module which instantiates MAC_int32_pipelined and MAC_fp32_pipelined within it
4. MAC_types.bsv -------------------------------> Contains all the struct definitions
5. MAC_with_wrapper.bsv ----------------------> Contains the MAC unit with modifications done to interface such that many instances of this module can be interconnected in a mesh network to realise a 4x4 systolic array.
6. Makefile --------------------------------------> Makefile which is used to generate verilog codes from bsv codes
7. Mat_A.txt ------------------------------------> Contains all the input matrix A generated randomly during simulation
8. Mat_AB.txt -----------------------------------> Contains all the output produced by the RTL during simulation
9. Mat_B.txt ------------------------------------> Contains all the input matrix B generated randomly during simulation
10. Mat_exp.txt ----------------------------------> Contains all the outputs generated by the reference model
11. Systolic_array_report_NS24Z353_DANIEL_MARK_ISAAC.pdf -----> Project report which contains detailed summary of work done in assignment_2
12. bf16_mul_pipelined.bsv ---------------------> Contains pipelined code which can do bf16 multiplication
13. fp32_add_pipelined.bsv ---------------------> Contains pipelined code which can do fp32 addition
14. systolic_array.bsv ----------------------------> Contains the main bsv code which interconnects sixteen MAC units in mesh network to create a 4x4 systolic array which can perform matrix multiplication.

# STEPS TO RUN SYSTOLIC ARRAY

1. Navigate to Assignment_2/ directory
```
cd Assignment_2/
```
2. activate pyenv
```
pyenv activate py38
```
3. compile and generate verilog from bsv
```
make generate_verilog
```
4. To simulate using cocotb, for random int testcases run the following command
```
make simulate PLUSARGS="+TESTCASES=<Desired number of testcases> +TEST_TYPE=TEST_RANDOM_INT"
```
where "Desired number of testcases" must be substituted with a number of testcases you wish to run. <br>  <br>
5. To simulate using cocotb, for random float testcases run the following command
```
make simulate PLUSARGS="+TESTCASES=<Desired number of testcases> +TEST_TYPE=TEST_RANDOM_FLOAT"
```
where "Desired number of testcases" must be substituted with a number of testcases you wish to run. <br>  <br>
6. To simulate using cocotb, for one of the inputs to be fixed as identity matrix and the other input matrix containing random integer values, run the following command
```
make simulate PLUSARGS="+TESTCASES=<Desired number of testcases> +TEST_TYPE=TEST_IDENTITY_INT"
```
where "Desired number of testcases" must be substituted with a number of testcases you wish to run. <br>  <br>
7. To simulate using cocotb, for one of the inputs to be fixed as identity matrix and the other input matrix containing random floating values, run the following command
```
make simulate PLUSARGS="+TESTCASES=<Desired number of testcases> +TEST_TYPE=TEST_IDENTITY_FLOAT"
```
where "Desired number of testcases" must be substituted with a number of testcases you wish to run. <br>  <br>
## To clean all the builds
```
make clean_build
```
